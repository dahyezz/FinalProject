<?xml version="1.0" encoding="UTF-8"?>

<!-- 마이바티스 3 Mapper DOCTYPE -->
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
    
<mapper namespace="web.dao.face.UsedDao">

	<select id="selectCntAll"
	    resultType="int">
	    SELECT count(*)
	    FROM UsedBoard_KG
	</select>
	
	<select id="selectAll"
	    resultType="web.dto.UsedBoard"
	    parameterType="web.util.Paging">
	    SELECT 
	    	boardno, tag, title, product,
		    content, writer, hit, price,
		    writtendate
	    FROM (
	    	SELECT rownum rnum, B.* FROM (
	    	    SELECT * FROM UsedBoard_KG
	    	    ORDER BY boardno DESC
	    	    ) B
	    	ORDER BY rnum
	    ) UsedBoard_KG
	    WHERE 
	         rnum BETWEEN #{startNo } AND #{endNo }
	</select>
	
	<select id="selectBoardno"
	    resultType="int">
	    SELECT usedboard_kg_seq.nextval FROM dual
	</select>
	
	<update id="updateHit"
	    parameterType="web.dto.UsedBoard">
	    UPDATE UsedBoard_KG
	    SET hit = hit + 1
	    WHERE boardno = #{boardno }
	</update>
	
	<select id="selectBoardByBoardno"
	    parameterType="int"
	    resultType="web.dto.UsedBoard">
		SELECT  
		    boardno, tag, title, product, 
		    content, writer, hit, 
		    price, writtendate
		FROM 
		    UsedBoard_KG
		WHERE 
		    boardno = #{boardno }
	</select>
	
	<insert id="write"
	    parameterType="web.dto.UsedBoard">
	    
	    <selectKey order="BEFORE" resultType="int"
			keyProperty="boardno">
				SELECT usedBoard_KG_SEQ.nextval FROM dual
		</selectKey>
	    
	    INSERT INTO UsedBoard_KG(
	        boardno, tag, title,
	        product, content, writer,
	        hit, price)
        VALUES( #{boardno }, #{tag }, #{title }, 
        #{product }, #{content }, #{writer }, 
        #{hit }, #{price }
	    )
	</insert>
	
	<insert id="insertImg"
		parameterType="web.dto.UsedImage">
		
		<selectKey order="BEFORE" resultType="int"
			keyProperty="usedImgNo">
				SELECT usedImg_KG_SEQ.nextval FROM dual
		</selectKey>
		
		INSERT INTO UsedImg_KG(usedimgno,
			originname, storedname)
		VALUES(#{usedImgNo },
			#{originName }, #{storedName })
	</insert>
	
	<select id="selectImgByBoardno"
		parameterType="int"
		resultType="web.dto.UsedImage">
		SELECT * FROM UsedImg_KG
		WHERE boardno = #{boardno }
	</select>
	
	<select id="selectImgByImgno"
		parameterType="int"
		resultType="web.dto.UsedImage">
		SELECT * FROM UsedImg_KG
		WHERE usedimgno = #{usedImgNo }
	</select>
	
	
	<update id="update"
		parameterType="web.dto.UsedBoard">
		UPDATE 
			usedboard_kg
		SET 
			tag=#{tag }, title=#{title }, 
			product=#{product }, price=#{price },
			content=#{content }
		WHERE
			boardno=#{boardno }
	</update>
	<update id="updateImgno" parameterType="Map">
		UPDATE 
		    USEDIMG_KG
		SET
		    boardno = #{boardno}
		WHERE
			usedimgno IN
			<foreach collection="images" separator="," open="(" close=")" item="val">
			${val}
			</foreach>
	</update>

</mapper>