<?xml version="1.0" encoding="UTF-8"?>

<!-- 마이바티스 3 Mapper DOCTYPE -->
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="web.dao.face.TastyBoardDao">

	<select id="selectCntAll" resultType="int">
		SELECT COUNT(*)
		FROM tastyboard_kg
	</select>
	
	<select id="selectAll" parameterType="web.util.Paging" resultType="web.dto.TastyBoard">
		SELECT boardno, tag, store_name storeName, loc, content, writer, hit, score, writtendate,
			 ( SELECT COUNT(*) FROM tastycomment_kg WHERE boardno = tastyboard_kg.boardno ) AS commentCnt
		FROM (
			SELECT rownum rnum, B.* FROM (
				SELECT * FROM tastyboard_kg
				ORDER BY boardno DESC
				) B
			ORDER BY rnum
		) tastyboard_kg
		WHERE rnum BETWEEN #{startNo } AND #{endNo }
	</select>
	
	<update id="updateHit" parameterType="web.dto.TastyBoard">
		UPDATE tastyboard_kg
		SET hit = hit + 1
		WHERE boardno = #{boardno }
	</update>
	
	<select id="selectBoardByBoardno" parameterType="web.dto.TastyBoard" resultType="web.dto.TastyBoard">
		SELECT boardno, tag, store_name storeName, loc, content, writer, hit, score, writtendate
		FROM tastyboard_kg
		WHERE boardno = #{boardno }
	</select>
	
	<insert id="insertBoard" parameterType="web.dto.TastyBoard">
	
<!-- 		<selectKey order="BEFORE" resultType="int" keyProperty="boardno"> -->
<!-- 			SELECT tastyboard_kg_seq.nextval FROM dual -->
<!-- 		</selectKey> -->

		INSERT INTO tastyboard_kg (boardno, tag, store_name, loc, content, writer, score) 
		VALUES (#{boardno }, #{tag }, #{storeName }, #{loc }, #{content } , #{writer }, #{score })
	</insert>
	
	<delete id="deleteBoardByBoardno" parameterType="web.dto.TastyBoard">
		DELETE FROM tastyboard_kg
		WHERE boardno = #{boardno }
	</delete>
	
	<update id="updateBoard" parameterType="web.dto.TastyBoard">
		UPDATE tastyboard_kg
		SET tag=#{tag }, store_name=#{storeName}, loc=#{loc }, content=#{content }, score=#{score }
		WHERE boardno = #{boardno }
	</update>
	
	<select id="selectBoardno" resultType="int">
<!-- 		SELECT max(boardno) boardno FROM tastyboard_kg -->
		SELECT tastyboard_kg_seq.nextval FROM dual
	</select>
	
	<insert id="insertFile" parameterType="web.dto.TastyFile">
	
		<selectKey order="BEFORE" resultType="int" keyProperty="fileno">
			SELECT tastyfile_kg_seq.nextval FROM dual
		</selectKey>
	
		INSERT INTO tastyfile_kg (fileno, boardno, origin_name, stored_name, filesize)
		VALUES (#{fileno }, #{boardno }, #{originName }, #{storedName }, #{filesize })
	</insert>
	
	<select id="selectFileByFileno" parameterType="int" resultType="web.dto.TastyFile">
		SELECT fileno, boardno, origin_name originName, stored_name storedName, filesize
		FROM tastyfile_kg
		WHERE fileno = #{fileno }
	</select>
	
	<select id="selectAllCommentByBoardno" parameterType="web.dto.TastyBoard" resultType="web.dto.TastyComment">
		SELECT commentno, boardno, writer, content, writtendate
		FROM tastycomment_kg
		WHERE boardno = #{boardno }
		ORDER BY commentno DESC
	</select>
	
	<insert id="insertComment" parameterType="web.dto.TastyComment">
		<selectKey order="BEFORE" resultType="int" keyProperty="commentno">
			SELECT tastycomment_kg_seq.nextval FROM dual
		</selectKey>
	
		INSERT INTO tastycomment_kg(commentno, boardno, writer, content)
		VALUES (#{commentno }, #{boardno }, #{writer }, #{content } )
	</insert>
	
	<select id="selectBoardnoByCommentno" parameterType="web.dto.TastyComment" resultType="web.dto.TastyComment">
		SELECT commentno, boardno, writer, content, writtendate
		FROM tastycomment_kg
		WHERE commentno = #{commentno }
	</select>
	
	<delete id="deleteComment" parameterType="web.dto.TastyComment">
		DELETE tastycomment_kg
		WHERE commentno = #{commentno }
	</delete>
	
	<delete id="deleteCommentByBoardno" parameterType="web.dto.TastyBoard">
		DELETE tastycomment_kg
		WHERE boardno = #{boardno }
	</delete>
	
	<delete id="deleteFileByboardno" parameterType="web.dto.TastyBoard">
		DELETE tastyfile_kg
		WHERE boardno = #{boardno }
	</delete>

</mapper>